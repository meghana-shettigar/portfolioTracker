<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Net Worth Dashboard</title>
  <style>
    body {
      background: #131722;
      color: #FFFFFF;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .top-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 20px;
    }
    .header-container {
      text-align: left;
      margin-left: 20px;
      flex: 1;
    }
    h1 {
      font-size: 2.5em;
      margin: 20px 0 10px;
      text-align: left;
    }
    .date-display {
      font-size: 1.5em;
      margin: 20px 0;
      color: #FFFFFF;
      text-align: left;
    }
    .person {
      display: inline-block;
      width: 45%;
      vertical-align: top;
      margin: 20px;
      background: #000000;
      padding: 15px;
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #000000;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #4A5568;
    }
    th {
      background: #2596be;
      color: #FFFFFF;
    }
    tr {
      background: #000000;
    }
    tr.total-row {
      font-weight: bold;
      background: #131722;
    }
    .clock-container {
      display: flex;
      justify-content: flex-start;
      gap: 20px;
      margin: 20px 0;
    }
    .clock {
      background: #1E222D;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.2em;
      color: #FFFFFF;
    }
    .clock-label {
      font-size: 0.8em;
      opacity: 0.8;
      color: #FFFFFF;
    }
    button {
      background: #1E222D;
      color: #FFFFFF;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:hover {
      background: #4A90E2;
    }
    .chart-container {
      float: right;
      width: 70%;
      max-width: 500px;
      max-height: 500px;
      margin-right: 20px;
    }
    #columns {
      clear: both;
      padding: 20px;
    }
    select {
      background: #1E222D;
      color: #FFFFFF;
      border: 1px solid #4A5568;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      cursor: pointer;
    }
    select:hover {
      background: #4A90E2;
    }
  </style>
</head>
<body>
  <div class="top-container">
    <div class="header-container">
      <button onclick="goFullScreen()">Go Full Screen</button>
      <select id="currency-select" onchange="debouncedUpdateCurrency()">
        <option value="GBP">GBP (Â£)</option>
        <option value="USD">USD ($)</option>
        <option value="INR">INR (â‚¹)</option>
      </select>
      <div class="date-display" id="date-display"></div>
      <div class="clock-container">
        <div class="clock">
          <div id="clock-uk"></div>
          <div class="clock-label">UK (BST)</div>
        </div>
        <div class="clock">
          <div id="clock-usa"></div>
          <div class="clock-label">USA (EDT)</div>
        </div>
        <div class="clock">
          <div id="clock-india"></div>
          <div class="clock-label">India (IST)</div>
        </div>
      </div>
      <h1 id="total"></h1>
    </div>
    <div class="chart-container">
      <canvas id="stockPieChart"></canvas>
    </div>
  </div>
  <div id="columns"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ðŸ”‘ Finnhub API Key
    const FINNHUB_API_KEY = "d2opmu9r01qga5gac8mgd2opmu9r01qga5gac8n0";

    // ðŸ”¹ Fallback exchange rates updated to current
    const FALLBACK_RATES = {
      USD_TO_GBP: 0.739,
      USD_TO_INR: 88.13,
      GBP_TO_INR: 119.25
    };

    // ðŸ”¹ Cached exchange rates
    let cachedExchangeRates = {
      GBP: FALLBACK_RATES.USD_TO_GBP,
      INR: FALLBACK_RATES.USD_TO_INR
    };

    // ðŸ”¹ Trading212 FX fee
    const FX_FEE_PERCENT = 0.0015; // 0.15%

    // ðŸ”¹ Fallback prices matching Trading212
    const FALLBACK_PRICES = {
      "IREN": 29.11, // Updated to match provided price
      "MARA": 15.85,
      "CON3.L": 6.55
    };

    // ðŸ”¹ Portfolio configuration (edit these as needed)
    const stocks = {
      NISHAN: [
        { ticker: "IREN", shares: 3343.637, buyPrice: 9.8, currency: "USD" },
        { ticker: "MARA", shares: 2891.738, buyPrice: 17.02, currency: "USD" },
        { ticker: "CON3.L", shares: 407.12, buyPrice: 20.06, currency: "USD" }
      ],
      MEGHANA: [
        { ticker: "IREN", shares: 3023.242984, buyPrice: 11.76, currency: "USD" },
        { ticker: "MARA", shares: 2151.218686, buyPrice: 15.76, currency: "USD" },
        { ticker: "CON3.L", shares: 1330.2, buyPrice: 12.6469, currency: "USD" }
      ]
    };

    // ðŸ”¹ Global variables for totals
    let globalTotalWorthGBP = 0;
    let globalTotalInvestedGBP = 0;

    // ðŸ”¹ Hardcoded total invested amount for header
    const HARDCODED_TOTAL_INVESTED_GBP = 112000; // Â£54,000 (Meghana) + Â£58,000 (Nishan)

    // ðŸ”¹ Full-screen function
    function goFullScreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      }
    }

    // ðŸ”¹ Update date and clocks
    function updateClocks() {
      const now = new Date();
      const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };

      document.getElementById('date-display').textContent = now.toLocaleDateString('en-GB', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        timeZone: 'Europe/London'
      });

      document.getElementById('clock-uk').textContent = now.toLocaleTimeString('en-GB', {
        ...options,
        timeZone: 'Europe/London'
      });
      document.getElementById('clock-usa').textContent = now.toLocaleTimeString('en-US', {
        ...options,
        timeZone: 'America/New_York'
      });
      document.getElementById('clock-india').textContent = now.toLocaleTimeString('en-IN', {
        ...options,
        timeZone: 'Asia/Kolkata'
      });
    }

    // ðŸ”¹ Fetch exchange rates from USD to target currency
    async function fetchExchangeRate(toCurrency) {
      if (cachedExchangeRates[toCurrency]) {
        return cachedExchangeRates[toCurrency];
      }
      const url = `https://open.er-api.com/v6/latest/USD`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.error(`Error fetching exchange rate: ${res.status} ${res.statusText}`);
          return FALLBACK_RATES[`USD_TO_${toCurrency}`] || 1;
        }
        const data = await res.json();
        if (!data.rates || typeof data.rates[toCurrency] !== 'number' || data.rates[toCurrency] <= 0) {
          console.error(`Invalid or missing rate for ${toCurrency}`);
          return FALLBACK_RATES[`USD_TO_${toCurrency}`] || 1;
        }
        cachedExchangeRates[toCurrency] = data.rates[toCurrency];
        return data.rates[toCurrency];
      } catch (err) {
        console.error(`Error fetching exchange rate for ${toCurrency}:`, err);
        return FALLBACK_RATES[`USD_TO_${toCurrency}`] || 1;
      }
    }

    // ðŸ”¹ Convert GBP to target currency using USD as base
    async function convertGBPToCurrency(amountGBP, toCurrency) {
      if (toCurrency === "GBP") return amountGBP;
      if (!Number.isFinite(amountGBP) || amountGBP < 0) {
        console.error(`Invalid amountGBP: ${amountGBP}`);
        return 0;
      }
      const usdToGbp = await fetchExchangeRate("GBP");
      const usdToTarget = await fetchExchangeRate(toCurrency);
      if (usdToGbp <= 0 || usdToTarget <= 0) {
        console.error(`Invalid exchange rates: USD_TO_GBP=${usdToGbp}, USD_TO_${toCurrency}=${usdToTarget}`);
        return amountGBP; // Fallback to GBP to avoid NaN
      }
      const gbpToTarget = usdToTarget / usdToGbp;
      return amountGBP * gbpToTarget;
    }

    // ðŸ”¹ Fetch stock price from Finnhub.io
    async function fetchPrice(ticker) {
      const formattedTicker = ticker.includes(".L") ? ticker.replace(".L", ".LON") : ticker;
      const url = `https://finnhub.io/api/v1/quote?symbol=${formattedTicker}&token=${FINNHUB_API_KEY}`;
      try {
        const res = await fetch(url);
        console.log(`Fetching ${ticker} (${formattedTicker}): Status ${res.status}`);
        if (!res.ok) {
          console.error(`Error fetching ${ticker}: ${res.status} ${res.statusText}`);
          return FALLBACK_PRICES[ticker] || null;
        }
        const data = await res.json();
        console.log(`Response for ${ticker}:`, data);
        return data.c || FALLBACK_PRICES[ticker] || null;
      } catch (err) {
        console.error(`Error fetching ${ticker}:`, err);
        return FALLBACK_PRICES[ticker] || null;
      }
    }

    // ðŸ”¹ Pie chart initialization
    let stockPieChart = null;

    // ðŸ”¹ Format number with commas
    function formatNumberWithCommas(number) {
      if (!Number.isFinite(number) || number === null || number === undefined) {
        console.error(`Invalid number for formatting: ${number}`);
        return "0.00";
      }
      return number.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // ðŸ”¹ Debounce function to limit rapid calls
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ðŸ”¹ Update currency display
    async function updateCurrency() {
      const currency = document.getElementById("currency-select").value;
      const currencySymbols = { GBP: "Â£", USD: "$", INR: "â‚¹" };
      const totalWorth = await convertGBPToCurrency(globalTotalWorthGBP, currency);
      const totalInvested = await convertGBPToCurrency(HARDCODED_TOTAL_INVESTED_GBP, currency);
      const totalProfitGBP = globalTotalWorthGBP - HARDCODED_TOTAL_INVESTED_GBP;
      const totalProfit = await convertGBPToCurrency(totalProfitGBP, currency);
      const totalProfitPercent = (HARDCODED_TOTAL_INVESTED_GBP !== 0) ? (totalProfitGBP / HARDCODED_TOTAL_INVESTED_GBP * 100) : 0;

      document.getElementById("total").innerHTML =
        `<br>
        <span style="color:#2596be">Total Net Worth: </span> ${currencySymbols[currency]}${formatNumberWithCommas(totalWorth)}<br>
         <span style="font-size:0.6em;color:#2596be">Invested: </span> <span style="font-size:0.6em"> ${currencySymbols[currency]}${formatNumberWithCommas(totalInvested)}</span><br>
         <span style="font-size:0.8em;color:${totalProfit >= 0 ? '#00A36C' : '#E63946'}">
           P/L: ${currencySymbols[currency]}${formatNumberWithCommas(totalProfit)} (${formatNumberWithCommas(totalProfitPercent)}%)
         </span>`;
    }

    // ðŸ”¹ Debounced updateCurrency
    const debouncedUpdateCurrency = debounce(updateCurrency, 500);

    async function calculate() {
      // Fetch USD to GBP spot rate
      const spot_USD_TO_GBP = await fetchExchangeRate("GBP");
      // Effective rate with Trading212 FX fee
      const effective_USD_TO_GBP = spot_USD_TO_GBP * (1 + FX_FEE_PERCENT);

      globalTotalWorthGBP = 0;
      globalTotalInvestedGBP = 0;
      const container = document.getElementById("columns");
      container.innerHTML = "";

      // Aggregate current GBP values for pie chart
      const stockValues = {
        "IREN": 0,
        "MARA": 0,
        "CON3.L": 0
      };

      // First pass: Calculate total worth and invested for percentage calculations
      for (const [person, list] of Object.entries(stocks)) {
        for (const s of list) {
          const currentPrice = await fetchPrice(s.ticker);
          if (!currentPrice) {
            console.warn(`No price data for ${s.ticker}, skipping`);
            continue;
          }
          let currentGBP, investedGBP;
          if (s.currency === "USD") {
            const currentUSD = currentPrice * s.shares;
            currentGBP = currentUSD * spot_USD_TO_GBP;
            investedGBP = s.buyPrice * s.shares * effective_USD_TO_GBP;
          } else {
            currentGBP = currentPrice * s.shares;
            investedGBP = s.buyPrice * s.shares;
          }
          stockValues[s.ticker] += currentGBP;
          globalTotalWorthGBP += currentGBP;
          globalTotalInvestedGBP += investedGBP;
        }
      }

      // Second pass: Generate tables
      for (const [person, list] of Object.entries(stocks)) {
        let personWorth = 0, personInvested = 0;

        let html = `<div class="person"><h2>${person.toUpperCase()}</h2>
        <table>
          <tr><th>Stock</th><th>Shares</th><th>Current Price ($)</th><th>Invested (Â£)</th><th>Current (Â£)</th><th>P/L (Â£)</th><th>P/L (%)</th></tr>`;

        for (const s of list) {
          const currentPrice = await fetchPrice(s.ticker);
          if (!currentPrice) {
            console.warn(`No price data for ${s.ticker}, skipping`);
            continue;
          }

          let investedGBP, currentGBP;
          if (s.currency === "USD") {
            investedGBP = s.investedGBP || (s.buyPrice * s.shares * effective_USD_TO_GBP);
            const currentUSD = currentPrice * s.shares;
            currentGBP = currentUSD * spot_USD_TO_GBP;
          } else {
            investedGBP = s.buyPrice * s.shares;
            currentGBP = currentPrice * s.shares;
          }

          const profit = currentGBP - investedGBP;
          const profitPercent = (investedGBP !== 0) ? (profit / investedGBP * 100) : 0;

          personInvested += investedGBP;
          personWorth += currentGBP;

          html += `<tr>
            <td>${s.ticker}</td>
            <td>${s.shares.toFixed(2)}</td>
            <td>${s.currency === "USD" ? "$" : "Â£"}${currentPrice.toFixed(2)}</td>
            <td>Â£${investedGBP.toFixed(2)}</td>
            <td>Â£${currentGBP.toFixed(2)}</td>
            <td style="color:${profit >= 0 ? '#00A36C' : '#E63946'}">
              Â£${profit.toFixed(2)}
            </td>
            <td style="color:${profit >= 0 ? '#00A36C' : '#E63946'}">
              ${profitPercent.toFixed(2)}%
            </td>
          </tr>`;
        }

        const personProfit = personWorth - personInvested;
        const personProfitPercent = (personInvested !== 0) ? (personProfit / personInvested * 100) : 0;

        html += `<tr class="total-row">
          <td colspan="2">TOTAL</td>
          <td>-</td>
          <td>Â£${personInvested.toFixed(2)}</td>
          <td>Â£${personWorth.toFixed(2)}</td>
          <td style="color:${personProfit >= 0 ? '#00A36C' : '#E63946'}">
            Â£${personProfit.toFixed(2)}
          </td>
          <td style="color:${personProfit >= 0 ? '#00A36C' : '#E63946'}">
            ${personProfitPercent.toFixed(2)}%
          </td>
        </tr>`;

        html += `</table></div>`;
        container.innerHTML += html;
      }

      // Update header with selected currency
      await updateCurrency();
    }

    // Initialize clocks and calculate
    updateClocks();
    setInterval(updateClocks, 1000);
    calculate();
    setInterval(calculate, 60000);
  </script>
</body>
</html>